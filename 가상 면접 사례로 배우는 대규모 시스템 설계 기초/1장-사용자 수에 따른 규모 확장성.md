# 1장 - 사용자 수에 따른 규모 확장성

## 단일 서버

### 사용자 요청 처리 흐름

1. 사용자가 도메인이름 (ex - api.mysite.com)으로 웹사이트에 접속
2. DNS에 질의하여 IP주소를 반환 (ex - 15.125.23.214)
3. IP주소로 요청이 전달.
4. 요청을 받은 웹서버는 HTML 페이지나 JSON 형태의 응답을 반환

## 데이터베이스

### 어떤 데이터베이스를 사용?

- 관계형 데이터베이스(RDB)와 비 관계형 데이터 베이스(NoSQL)
- 비 관계형 데이터베이스를 쓰는 경우
    - 낮은 응답 지연시간(latency)가 요구됨
    - 다루는 데이터가 비정형이라 관계형 데이터가 아님
    - 데이터(json, yaml, xml)을 직렬화하거나 역직렬화하기만 하면 되는 경우
    - 많은 양의 데이터를 저장할 경우

## 수직적 규모 확장 vs 수평적 규모 확장

- 수직적 규모 확장(scale-up) : 서버에 고사양 자원을 추가.
    - 한대의 서버에 CPU나 메모리를 증설할 방법은 한계가 있음.
    - 장애에 대한 자동복구나 다중화 방안이 없음
- 수평적 규모 확장(scale-out) : 더 많은 서버를 추가하여 성능을 개선.
    - 대규모 어플리케이션을 지원하는데 적절한 방법

### 로드밸런서

- 웹서버와 단말기(브라우저, 앱) 사이에 부하를 분산하는 역할을 하는 서버.
- 사용자는 로드밸런서의 공개 IP주소로 접속
- 로드밸런서 - 웹서버간 통신에는 사설 IP주소를 사용. (인터넷을 통한 접속 불가)
- 장애 복구 능력, 가용성 향상

### 데이터베이스 다중화

- 서버사이에 주-부 관계를 설정하고 데이터 원본은 주서버에, 사본은 부서버에 저장하는 방식
- 쓰기연산은 주 서버를 거치며, 읽기 연산은 부 서버를 거침.
- 더 나은 성능 : 병렬로 처리되는 질의의 수가 늘어나므로 성능이 좋아짐.
- 안정성 : 데이터베이스 일부가 파괴되어도 데이터는 보존
- 가용성 : 하나의 데이터베이스 서버가 장애가 발생하더라고 다른 서버의 데이터를 가져와 서비스할 수 있음.

## 캐시

애플리케이션의 성능은 데이터베이스를 얼마나 자주 호출하느냐에 크게 좌우되는데, 캐시는 그런 문제를 완화할 수 있다.

### 캐시 계층

- 캐시에 응답이 저장되어 있는지 확인하고 있으면 클라이언트에 바로 반환.
- 없으면 데이터베이스 질의를 통해 데이터를 찾아 캐시에 저장한뒤 클라이언트에 반환.

### 캐시 사용시 유의할 점

- 캐시는 어떤 상황에 바람직한가? 갱신은 자주 일어나지 않지만 참조는 빈번한 경우
- 어떤 데이터를 캐시에 두어야 하는가? 캐시는 휘발성 메모리에 데이터를 저장하므로, 중요한 데이터는 여전히 지속적 저장소에 두어야 한다.
- 캐시에 보관된 데이터는 언제 만료되는가? 만료된 데이터는 캐시에서 삭제되어야 하며 만료정책이 필요.
- 일관성은 어떻게 유지되는가? 여러 지역에 걸쳐 시스템을 확장해 나가는 경우 캐시와 저장소의 일관성 유지는 어려운 문제.
- 장애 대처는 ? 단일 장애 지점 (Single Point of Failure)를 피하기 위해선 분산이 필요.
- 캐시 메모리는 얼마나 크게 잡을 것인가? 캐시 메모리를 과할당하면 캐시에 보관될 데이터가 갑자기 늘어났을 때 생길 문제도 방지할 수 있다.
- 데이터 방출 정책은 무엇인가? LRU가 가장 보편적이며, LFU, FIFO 등도 쓰인다.

## CDN

정적 콘텐츠를 전송하는데 쓰이는 네트워크

### CDN 사용시 고려사항

- 비용 : CDN 양에 따라 비용을 내게 되므로 자주 사용되지 않는 콘텐츠는 CDN에서 빼는 것이 좋음.
- 적절한 만료 시한 설정 : 시의성이 중요한 콘텐츠의 경우 만료 시점을 잘 정해야 함.
- CDN 장애시 대처 방안 : 원본 서버로부터 직접 콘텐츠를 가져오도록 구성해두어야 함.
- 콘텐츠 무효화 방법
    - CDN 서비스 사업자에서 제공하는 API를 활용
    - 오브젝트 버저닝을 이용 . ex) image.png?v=2

## 무상태 웹 계층

상태 의존적인 아키텍쳐는 같은 클라이언트에는 같은 서버를 전송해야 한다는 부담이 있으므로,

상태 정보를 웹서버로부터 분리시키고 별도 공유 저장소를 사용하며 무상태 아키텍쳐를 사용.

## 데이터 센터

전 세계에서의 가용성을 높이기 위해 데이터 센터를 활용하며,

지리적 라우팅을 이용하여 사용자를 가장 가까운 데이터 센터에 안내.

다중 데이터센터를 만들려면 다음과 같은 난제를 해결해야 함.

- 트래픽 우회 : 지리적 라우팅(GeoDNS)를 활용
- 데이터 동기화 : 데이터를 여러 데이터 센터에 걸쳐 다중화
- 테스트와 배포 : 자동화된 배포 도구는 모든 데이터 센터에 동일한 서비스가 설치되도록 중요한 역할을 함.

## 메시지 큐

메시지의 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트.

- 생산자 혹은 발행자라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행.
- 큐에는 소비자 혹은 구독자가 연결되어 있어 메시지를 받아 그에 맞는 동작을 수행.
- 서버 간 결합이 느슨해져서 규모 확장성, 안정성에 도움을 줌.

## 로그, 메트릭, 자동화

- 로그 : 단일 서비스로 모아주는 도구를 활용하면 더 편리.
- 메트릭
    - 호스트 단위 메트릭 : CPU, 메모리, 디스크 IO
    - 종합 메트릭 : 데이터베이스 계층의 성능, 캐시 계층의 성능
    - 핵심 비즈니스 메트릭 : DAU, 수익, 재방문
- 자동화 : CI,CD 등의 도구

## 데이터베이스의 규모 확장

### 수직적 확장

- 아마존 RDS의 경우 24TB RAM을 갖춘 서버도 상품으로 제공
- 스택오버플로우의 경우 2013년 한해 동안 방문한 천만 명의 사용자 전부를 한대의 마스터 DB로 처리
- 하지만 증설 한계, SPOF, 고비용 등의 문제가 있음.

### 수평적 확장

- 대규모 DB를 샤드라는 작은 단위로 분할(샤딩)
- 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼인 샤딩키 (파티션 키)를 정하는 것이 중요함.

**샤딩으로 인한 문제**

- 데이터의 재 샤딩
    - 데이터가 너무 많아져서 하나의 샤드로는 감당하기 어려울 때
    - 샤드 간 데이터 분포가 균등하지 못하여 어떤 샤드에 할당된 공간 소모가 다른 샤드에 비해 빨리 진행될 때 (샤드소진)
- 유명인사 문제
    - 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제.
    - 샤드를 더 분할해야 함.
- 조인과 비정규화
    - 여러 샤드에 걸친 데이터를 조인하기 어려움.
    - DB를 비정규화하는 방법이 있음.

## 시스템 규모 확장을 위한 기법들

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 많은 데이터를 캐싱
- 여러 데이터 센터를 지원
- 정적 콘텐츠는 CDN 적용
- 데이터 계층은 샤딩을 통해 규모 확장
- 각 계층은 독립적 서비스로 분할
- 시스템을 지속적으로 모니터링하고 자동화 도구들을 활용
